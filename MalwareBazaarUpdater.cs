using System;
using System.Collections.Generic;
using System.IO;
using System.Net;
using System.IO.Compression;

namespace PadZahr.Security
{
    public static class MalwareBazaarUpdater
    {
        // download existing hashes from malware bazar website
        private const string DownloadUrl =
            "https://bazaar.abuse.ch/export/txt/sha256/full/";

        // making our database based on existing hashes from malware bazar 
        private static readonly string DbPath =
            Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "MalwareHashes.db");

        // load downloaded hashes
        public static HashSet<string> LoadHashes()
        {
            if (!File.Exists(DbPath))
                return new HashSet<string>(StringComparer.OrdinalIgnoreCase);

            return new HashSet<string>(
                File.ReadAllLines(DbPath),
                StringComparer.OrdinalIgnoreCase
            );
        }
        // update hashes
        public static void UpdateDatabase()
        {
            string zipPath = Path.Combine(Path.GetTempPath(), "bazaar.zip");
            string extractDir = Path.Combine(Path.GetTempPath(), "bazaar");

            using (WebClient wc = new WebClient())
            {
                wc.DownloadFile(DownloadUrl, zipPath);
            }

            if (Directory.Exists(extractDir))
                Directory.Delete(extractDir, true);

            ZipFile.ExtractToDirectory(zipPath, extractDir);

            var hashes = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

            foreach (var file in Directory.GetFiles(extractDir))
            {
                foreach (var line in File.ReadAllLines(file))
                {
                    if (line.Length == 64) // SHA256
                        hashes.Add(line);
                }
            }

            File.WriteAllLines(DbPath, hashes);

            File.Delete(zipPath);
            Directory.Delete(extractDir, true);
            SaveLastUpdate(DateTime.UtcNow);
        }

        private static void SaveLastUpdate(DateTime time)
        {
            File.WriteAllText(DbPath, time.ToString("O"));
        }

        public static DateTime? GetLastUpdate()
        {
            if (!File.Exists(DbPath))
                return null;

            if (DateTime.TryParse(File.ReadAllText(DbPath), out var dt))
                return dt;

            return null;
        }

        public static bool IsUpdateRecommended()
        {
            var last = GetLastUpdate();
            if (last == null)
                return true;

            return (DateTime.UtcNow - last.Value).TotalDays >= 1;
        }
    }
    
}
